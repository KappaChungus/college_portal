<div class="max-w-7xl mx-auto">
  <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-6" data-i18n="profile">Profile</h1>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Profile Information Card -->
    <div class="md:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
    <div id="profile-loading" class="flex items-center justify-center py-8">
      <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="ml-3 text-gray-600 dark:text-gray-300" data-i18n="loading">Loading...</span>
    </div>

    <div id="profile-content" class="hidden">
      <div class="space-y-6">
        <!-- Name -->
        <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
          <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1" data-i18n="name">Name</label>
          <p id="profile-name" class="text-lg text-gray-900 dark:text-gray-100 font-semibold"></p>
        </div>

        <!-- Email -->
        <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
          <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1" data-i18n="email">Email</label>
          <p id="profile-email" class="text-lg text-gray-900 dark:text-gray-100"></p>
        </div>

        <!-- Science Title -->
        <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
          <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-1" data-i18n="science_title">Science Title</label>
          <p id="profile-science-title" class="text-lg text-gray-900 dark:text-gray-100"></p>
        </div>

        <!-- Groups -->
        <div class="pb-4">
          <label class="block text-sm font-medium text-gray-500 dark:text-gray-400 mb-2" data-i18n="groups">Groups</label>
          <div id="profile-groups" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </div>

    <div id="profile-error" class="hidden text-center py-8 text-red-600 dark:text-red-400"></div>
  </div>

  <!-- Quick Overview Stats -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
    <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4 flex items-center">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
      </svg>
      <span data-i18n="quick_overview">Quick Overview</span>
    </h2>
    
    <!-- Loading state for stats -->
    <div id="stats-loading" class="flex items-center justify-center py-8">
      <svg class="animate-spin h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </div>

    <div id="stats-content" class="hidden space-y-4">
      <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
        <div class="text-sm text-gray-600 dark:text-gray-400" data-i18n="total_courses">Total Courses</div>
        <div id="total-courses" class="text-2xl font-bold text-blue-600 dark:text-blue-400">-</div>
      </div>
      
      <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4">
        <div class="text-sm text-gray-600 dark:text-gray-400" data-i18n="total_students">Total Students</div>
        <div id="total-students" class="text-2xl font-bold text-green-600 dark:text-green-400">-</div>
      </div>
    </div>

    <div id="stats-error" class="hidden text-center py-8 text-red-600 dark:text-red-400"></div>
  </div>

  </div>
</div>

<script type="module">
import { apiGet } from 'utils/api';
import { hide, show, setText } from 'utils/dom';

window.apiGet = apiGet;

async function loadProfile() {
  const loading = document.getElementById('profile-loading');
  const content = document.getElementById('profile-content');
  const error = document.getElementById('profile-error');
  
  // Guard against missing elements (e.g., during Turbo navigation)
  if (!loading || !content || !error) return;
  
  try {
    const profile = await apiGet('/api/teacher/profile');
    
    hide(loading);
    show(content);

    // Populate profile data
    setText(document.getElementById('profile-name'), profile.name || 'N/A');
    setText(document.getElementById('profile-email'), profile.email || 'N/A');
    setText(document.getElementById('profile-science-title'), profile.science_title || 'N/A');
    
    // Populate groups
    const groupsContainer = document.getElementById('profile-groups');
    groupsContainer.innerHTML = '';
    
    if (profile.groups && profile.groups.length > 0) {
      profile.groups.forEach(group => {
        const badge = document.createElement('span');
        badge.className = 'px-3 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full text-sm font-medium';
        badge.textContent = group.name;
        groupsContainer.appendChild(badge);
      });
    } else {
      groupsContainer.innerHTML = '<span class="text-gray-500 dark:text-gray-400">N/A</span>';
    }

  } catch (err) {
    console.error('Error loading profile:', err);
    hide(loading);
    setText(error, 'Failed to load profile. Please refresh the page.');
    show(error);
  }
}

async function loadStats() {
  const statsLoading = document.getElementById('stats-loading');
  const statsContent = document.getElementById('stats-content');
  const statsError = document.getElementById('stats-error');
  
  // Guard against missing elements (e.g., during Turbo navigation)
  if (!statsLoading || !statsContent || !statsError) return;
  
  try {
    const stats = await apiGet('/api/teacher/profile/stats');
    
    hide(statsLoading);
    show(statsContent);

    // Populate stats
    setText(document.getElementById('total-courses'), stats.total_courses || 0);
    setText(document.getElementById('total-students'), stats.total_students || 0);

  } catch (err) {
    console.error('Error loading stats:', err);
    hide(statsLoading);
    setText(statsError, 'Failed to load statistics.');
    show(statsError);
  }
}

function loadAll() {
  loadProfile();
  loadStats();
}

// Load data on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadAll);
} else {
  loadAll();
}

// Handle Turbo navigation
document.addEventListener('turbo:before-cache', function() {
  const profileLoading = document.getElementById('profile-loading');
  const profileContent = document.getElementById('profile-content');
  const profileError = document.getElementById('profile-error');
  const statsLoading = document.getElementById('stats-loading');
  const statsContent = document.getElementById('stats-content');
  const statsError = document.getElementById('stats-error');
  
  if (profileLoading) show(profileLoading);
  if (profileContent) hide(profileContent);
  if (profileError) hide(profileError);
  if (statsLoading) show(statsLoading);
  if (statsContent) hide(statsContent);
  if (statsError) hide(statsError);
});

document.addEventListener('turbo:load', loadAll);

// Reload on language change
window.addEventListener('languageChanged', loadAll);
</script>
