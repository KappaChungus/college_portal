<!DOCTYPE html>
<html>
  <head>
    <title>Teacher Panel</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="bg-gray-50 dark:bg-gray-900 transition-colors">
    <div class="flex flex-col h-screen">
      <!-- Header -->
      <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 transition-colors">
        <div class="flex items-center justify-between px-6 py-4">
          <!-- Left: College Portal Name -->
          <div class="flex items-center">
            <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400">College Portal</h1>
          </div>

          <!-- Right: Dark Mode, Language, User Menu -->
          <div class="flex items-center gap-4">
            <!-- Dark Mode Toggle -->
            <button id="dark-mode-toggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Toggle dark mode">
              <svg id="sun-icon" class="w-6 h-6 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
              </svg>
              <svg id="moon-icon" class="w-6 h-6 text-gray-700 dark:text-gray-300 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
              </svg>
            </button>

            <!-- Language Selector -->
            <div class="relative">
              <button id="language-button" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                </svg>
                <span id="current-language" class="text-sm font-medium text-gray-700 dark:text-gray-300">EN</span>
                <svg class="w-4 h-4 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              <!-- Language Dropdown -->
              <div id="language-dropdown" class="hidden absolute right-0 mt-2 w-32 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 py-1 z-50">
                <button data-lang="en" class="language-option block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                  ðŸ‡¬ðŸ‡§ English
                </button>
                <button data-lang="pl" class="language-option block w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                  ðŸ‡µðŸ‡± Polish
                </button>
              </div>
            </div>

            <!-- User Menu -->
            <div class="relative">
              <button id="user-menu-button" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <div class="w-8 h-8 bg-blue-600 dark:bg-blue-500 rounded-full flex items-center justify-center">
                  <span class="text-white font-medium text-sm"><%= current_user.name.first.upcase if current_user.name.present? %></span>
                </div>
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                  <span data-i18n="hello">Hello</span>, <%= current_user.name.split.first if current_user.name.present? %>
                </span>
                <svg class="w-4 h-4 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
              <!-- User Dropdown -->
              <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 py-1 z-50">
                <%= link_to profile_path, class: "flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" do %>
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                  <span data-i18n="profile">Profile</span>
                <% end %>
                <%= button_to destroy_user_session_path, method: :delete, class: "flex items-center gap-2 w-full px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors", form: { class: "w-full" } do %>
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                  </svg>
                  <span data-i18n="logout">Log Out</span>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white dark:bg-gray-800 shadow-md p-4 overflow-y-auto transition-colors">
          <nav class="space-y-2">
            <%= link_to dashboard_path, class: "block py-2 px-3 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" do %>
              <span data-i18n="dashboard">Dashboard</span>
            <% end %>
            <%= link_to manage_courses_path, class: "block py-2 px-3 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" do %>
              <span data-i18n="my_courses">My Courses</span>
            <% end %>
            <%= link_to schedule_path, class: "block py-2 px-3 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" do %>
              <span data-i18n="schedule">Schedule</span>
            <% end %>
            <%= link_to surveys_path, class: "block py-2 px-3 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" do %>
              <span data-i18n="survey_results">Survey Results</span>
            <% end %>
          </nav>
        </aside>

        <!-- Main content -->
        <main class="flex-1 overflow-y-auto p-6 bg-gray-50 dark:bg-gray-900 transition-colors">
          <%= yield %>
        </main>
      </div>
    </div>

    <script>
      console.log('Script loaded!');
      
      function initializeHeader() {
        console.log('Initializing header...');
        
        // Dark Mode Toggle
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const html = document.documentElement;

        console.log('Dark mode toggle element:', darkModeToggle);
        
        if (!darkModeToggle) {
          console.error('Dark mode toggle button not found!');
          return;
        }

        // Check for saved dark mode preference on load
        const savedDarkMode = localStorage.getItem('darkMode');
        console.log('Saved dark mode:', savedDarkMode);
        
        if (savedDarkMode === 'true') {
          html.classList.add('dark');
        } else {
          html.classList.remove('dark');
        }

        // Update icon visibility based on current mode
        const updateDarkModeIcons = () => {
          const sunIconEl = document.getElementById('sun-icon');
          const moonIconEl = document.getElementById('moon-icon');
          const isDark = html.classList.contains('dark');
          
          console.log('Updating icons, isDark:', isDark);
          
          if (isDark) {
            sunIconEl?.classList.add('hidden');
            moonIconEl?.classList.remove('hidden');
          } else {
            sunIconEl?.classList.remove('hidden');
            moonIconEl?.classList.add('hidden');
          }
        };

        // Initial icon update
        updateDarkModeIcons();

        // Remove old event listeners by cloning and replacing
        const newDarkModeToggle = darkModeToggle.cloneNode(true);
        darkModeToggle.parentNode.replaceChild(newDarkModeToggle, darkModeToggle);
        
        newDarkModeToggle.addEventListener('click', (e) => {
          console.log('Dark mode toggle clicked!');
          e.preventDefault();
          e.stopPropagation();
          
          html.classList.toggle('dark');
          const isDark = html.classList.contains('dark');
          console.log('New dark mode state:', isDark);
          
          localStorage.setItem('darkMode', isDark.toString());
          
          // Update icons after toggle
          updateDarkModeIcons();
        });
        
        console.log('Dark mode toggle initialized');

        // Language Dropdown
        const languageButton = document.getElementById('language-button');
        const languageDropdown = document.getElementById('language-dropdown');

        if (languageButton) {
          const newLanguageButton = languageButton.cloneNode(true);
          languageButton.parentNode.replaceChild(newLanguageButton, languageButton);
          
          newLanguageButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('language-dropdown');
            dropdown?.classList.toggle('hidden');
            // Close user dropdown if open
            document.getElementById('user-dropdown')?.classList.add('hidden');
          });
        }

        // Language option click handlers - use event delegation
        document.addEventListener('click', (e) => {
          if (e.target.classList.contains('language-option')) {
            const lang = e.target.getAttribute('data-lang');
            if (lang && window.changeLanguage) {
              window.changeLanguage(lang);
            }
          }
        });

        // Load saved language preference (changeLanguage is defined in i18n.js)
        const savedLanguage = localStorage.getItem('language') || 'en';
        const currentLanguageEl = document.getElementById('current-language');
        if (currentLanguageEl) {
          currentLanguageEl.textContent = savedLanguage.toUpperCase();
        }

        // User Menu Dropdown
        const userMenuButton = document.getElementById('user-menu-button');
        const userDropdown = document.getElementById('user-dropdown');

        if (userMenuButton) {
          const newUserMenuButton = userMenuButton.cloneNode(true);
          userMenuButton.parentNode.replaceChild(newUserMenuButton, userMenuButton);
          
          newUserMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('user-dropdown');
            dropdown?.classList.toggle('hidden');
            // Close language dropdown if open
            document.getElementById('language-dropdown')?.classList.add('hidden');
          });
        }

        // Close dropdowns when clicking outside (remove old listener first)
        document.removeEventListener('click', window.headerClickHandler);
        window.headerClickHandler = (e) => {
          const languageBtn = document.getElementById('language-button');
          const userBtn = document.getElementById('user-menu-button');
          const langDropdown = document.getElementById('language-dropdown');
          const usrDropdown = document.getElementById('user-dropdown');
          
          if (languageBtn && !languageBtn.contains(e.target)) {
            langDropdown?.classList.add('hidden');
          }
          if (userBtn && !userBtn.contains(e.target)) {
            usrDropdown?.classList.add('hidden');
          }
        };
        document.addEventListener('click', window.headerClickHandler);
      }

      // Initialize on page load
      console.log('Setting up initialization...');
      
      if (document.readyState === 'loading') {
        console.log('Document still loading, waiting for DOMContentLoaded');
        document.addEventListener('DOMContentLoaded', initializeHeader);
      } else {
        console.log('Document already loaded, initializing now');
        initializeHeader();
      }

      // Re-initialize after Turbo navigation
      document.addEventListener('turbo:load', () => {
        console.log('turbo:load event fired');
        initializeHeader();
      });
      
      document.addEventListener('turbo:render', () => {
        console.log('turbo:render event fired');
        initializeHeader();
      });
    </script>
  </body>
</html>
