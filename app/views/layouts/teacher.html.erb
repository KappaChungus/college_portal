<!DOCTYPE html>
<html>
  <head>
    <title>Teacher Panel</title>
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="bg-gray-50 dark:bg-gray-900 transition-colors">
    <div class="flex flex-col h-screen">
      <%= render 'shared/header', user_type: 'teacher' %>

      <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-64 bg-white dark:bg-gray-800 shadow-md p-4 overflow-y-auto transition-colors">
          <nav class="space-y-2">
            <%= link_to profile_path, class: "block py-2 px-3 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" do %>
              <span data-i18n="profile">Profile</span>
            <% end %>
            <%= link_to dashboard_path, class: "block py-2 px-3 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" do %>
              <span data-i18n="dashboard">Dashboard</span>
            <% end %>
            <%= link_to manage_courses_path, class: "block py-2 px-3 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" do %>
              <span data-i18n="my_courses">My Courses</span>
            <% end %>
            <%= link_to schedule_path, class: "block py-2 px-3 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" do %>
              <span data-i18n="schedule">Schedule</span>
            <% end %>
            <%= link_to surveys_path, class: "block py-2 px-3 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" do %>
              <span data-i18n="survey_results">Survey Results</span>
            <% end %>
            
          </nav>
        </aside>

        <!-- Main content -->
        <main class="flex-1 overflow-y-auto p-6 bg-gray-50 dark:bg-gray-900 transition-colors">
          <%= yield %>
        </main>
      </div>
    </div>

    <script>
      console.log('Script loaded!');
      
      function initializeHeader() {
        console.log('Initializing header...');
        
        // Dark Mode Toggle
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const html = document.documentElement;

        console.log('Dark mode toggle element:', darkModeToggle);
        
        if (!darkModeToggle) {
          console.error('Dark mode toggle button not found!');
          return;
        }

        // Check for saved dark mode preference on load
        const savedDarkMode = localStorage.getItem('darkMode');
        console.log('Saved dark mode:', savedDarkMode);
        
        if (savedDarkMode === 'true') {
          html.classList.add('dark');
        } else {
          html.classList.remove('dark');
        }

        // Update icon visibility based on current mode
        const updateDarkModeIcons = () => {
          const sunIconEl = document.getElementById('sun-icon');
          const moonIconEl = document.getElementById('moon-icon');
          const isDark = html.classList.contains('dark');
          
          console.log('Updating icons, isDark:', isDark);
          
          if (isDark) {
            sunIconEl?.classList.add('hidden');
            moonIconEl?.classList.remove('hidden');
          } else {
            sunIconEl?.classList.remove('hidden');
            moonIconEl?.classList.add('hidden');
          }
        };

        // Initial icon update
        updateDarkModeIcons();

        // Remove old event listeners by cloning and replacing
        const newDarkModeToggle = darkModeToggle.cloneNode(true);
        darkModeToggle.parentNode.replaceChild(newDarkModeToggle, darkModeToggle);
        
        newDarkModeToggle.addEventListener('click', (e) => {
          console.log('Dark mode toggle clicked!');
          e.preventDefault();
          e.stopPropagation();
          
          html.classList.toggle('dark');
          const isDark = html.classList.contains('dark');
          console.log('New dark mode state:', isDark);
          
          localStorage.setItem('darkMode', isDark.toString());
          
          // Update icons after toggle
          updateDarkModeIcons();
        });
        
        console.log('Dark mode toggle initialized');

        // Language Dropdown
        const languageButton = document.getElementById('language-button');
        const languageDropdown = document.getElementById('language-dropdown');

        if (languageButton) {
          const newLanguageButton = languageButton.cloneNode(true);
          languageButton.parentNode.replaceChild(newLanguageButton, languageButton);
          
          newLanguageButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('language-dropdown');
            dropdown?.classList.toggle('hidden');
            // Close user dropdown if open
            document.getElementById('user-dropdown')?.classList.add('hidden');
          });
        }

        // Language option click handlers - use event delegation
        document.addEventListener('click', (e) => {
          if (e.target.classList.contains('language-option')) {
            const lang = e.target.getAttribute('data-lang');
            if (lang && window.changeLanguage) {
              window.changeLanguage(lang);
            }
          }
        });

        // Load saved language preference (changeLanguage is defined in i18n.js)
        const savedLanguage = localStorage.getItem('language') || 'en';
        const currentLanguageEl = document.getElementById('current-language');
        if (currentLanguageEl) {
          currentLanguageEl.textContent = savedLanguage.toUpperCase();
        }

        // User Menu Dropdown
        const userMenuButton = document.getElementById('user-menu-button');
        const userDropdown = document.getElementById('user-dropdown');

        if (userMenuButton) {
          const newUserMenuButton = userMenuButton.cloneNode(true);
          userMenuButton.parentNode.replaceChild(newUserMenuButton, userMenuButton);
          
          newUserMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const dropdown = document.getElementById('user-dropdown');
            dropdown?.classList.toggle('hidden');
            // Close language dropdown if open
            document.getElementById('language-dropdown')?.classList.add('hidden');
          });
        }

        // Close dropdowns when clicking outside (remove old listener first)
        document.removeEventListener('click', window.headerClickHandler);
        window.headerClickHandler = (e) => {
          const languageBtn = document.getElementById('language-button');
          const userBtn = document.getElementById('user-menu-button');
          const langDropdown = document.getElementById('language-dropdown');
          const usrDropdown = document.getElementById('user-dropdown');
          
          if (languageBtn && !languageBtn.contains(e.target)) {
            langDropdown?.classList.add('hidden');
          }
          if (userBtn && !userBtn.contains(e.target)) {
            usrDropdown?.classList.add('hidden');
          }
        };
        document.addEventListener('click', window.headerClickHandler);
      }

      // Initialize on page load
      console.log('Setting up initialization...');
      
      if (document.readyState === 'loading') {
        console.log('Document still loading, waiting for DOMContentLoaded');
        document.addEventListener('DOMContentLoaded', initializeHeader);
      } else {
        console.log('Document already loaded, initializing now');
        initializeHeader();
      }

      // Re-initialize after Turbo navigation
      document.addEventListener('turbo:load', () => {
        console.log('turbo:load event fired');
        initializeHeader();
      });
      
      document.addEventListener('turbo:render', () => {
        console.log('turbo:render event fired');
        initializeHeader();
      });
    </script>
  </body>
</html>
