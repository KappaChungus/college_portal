<div class="max-w-7xl mx-auto">
  <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-8" data-i18n="weekly_schedule">Weekly Schedule</h1>

  <!-- Loading State -->
  <div id="schedule-loading" class="flex items-center justify-center py-12">
    <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <span class="ml-3 text-gray-600 dark:text-gray-300" data-i18n="loading_schedule">Loading schedule...</span>
  </div>

  <!-- Schedule Table -->
  <div id="schedule-content" class="hidden bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full border-collapse">
        <thead>
          <tr class="bg-gray-50 dark:bg-gray-700">
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider border-r border-gray-200 dark:border-gray-600 w-24" data-i18n="time">
              Time
            </th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider border-r border-gray-200 dark:border-gray-600" data-i18n="monday">
              Monday
            </th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider border-r border-gray-200 dark:border-gray-600" data-i18n="tuesday">
              Tuesday
            </th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider border-r border-gray-200 dark:border-gray-600" data-i18n="wednesday">
              Wednesday
            </th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider border-r border-gray-200 dark:border-gray-600" data-i18n="thursday">
              Thursday
            </th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider border-r border-gray-200 dark:border-gray-600" data-i18n="friday">
              Friday
            </th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider border-r border-gray-200 dark:border-gray-600" data-i18n="saturday">
              Saturday
            </th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider" data-i18n="sunday">
              Sunday
            </th>
          </tr>
        </thead>
        <tbody id="schedule-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
          <!-- Rows will be generated by JavaScript -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Empty State -->
  <div id="schedule-empty" class="hidden text-center py-12 bg-white dark:bg-gray-800 rounded-lg shadow-md">
    <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
    </svg>
    <p class="mt-2 text-gray-600 dark:text-gray-300" data-i18n="no_schedule">No schedule available</p>
  </div>

  <!-- Error State -->
  <div id="schedule-error" class="hidden text-center py-12 text-red-600 dark:text-red-400"></div>
</div>

<!-- Tooltip for course details -->
<div id="course-tooltip" class="hidden fixed bg-gray-900 dark:bg-gray-700 text-white text-sm rounded-lg shadow-lg p-4 z-50 max-w-xs" style="pointer-events: none;">
  <div id="tooltip-content"></div>
</div>

<script>
  const DAYS = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
  const DAY_NUMBER_TO_NAME = {
    1: 'monday',
    2: 'tuesday', 
    3: 'wednesday',
    4: 'thursday',
    5: 'friday',
    6: 'saturday',
    0: 'sunday',
    7: 'sunday'
  };
  const HOURS = Array.from({ length: 15 }, (_, i) => i + 6); // 6 AM to 8 PM (6-20)

  function formatTime(hour) {
    const period = hour >= 12 ? 'PM' : 'AM';
    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
    return `${displayHour}:00 ${period}`;
  }

  function parseTime(timeStr) {
    // Parse ISO date format "2000-01-01T11:30:00.000Z" or "HH:MM:SS"
    let hours, minutes;
    
    if (timeStr.includes('T')) {
      // ISO format
      const date = new Date(timeStr);
      hours = date.getUTCHours();
      minutes = date.getUTCMinutes();
    } else {
      // "HH:MM:SS" format
      [hours, minutes] = timeStr.split(':').map(Number);
    }
    
    return hours + (minutes / 60);
  }

  function showTooltip(event, session) {
    const tooltip = document.getElementById('course-tooltip');
    const tooltipContent = document.getElementById('tooltip-content');
    
    const teacherLabel = window.t ? window.t('teacher') : 'Teacher';
    const timeLabel = window.t ? window.t('time') : 'Time';
    const roomLabel = window.t ? window.t('room') : 'Room';
    
    tooltipContent.innerHTML = `
      <div class="space-y-2">
        <div class="font-semibold text-lg border-b border-gray-600 pb-2">
          ${session.course.code} - ${session.course.title}
        </div>
        <div>
          <span class="text-gray-300">${teacherLabel}:</span>
          <span class="text-white">${session.teacher?.name || 'N/A'}</span>
        </div>
        <div>
          <span class="text-gray-300">${timeLabel}:</span>
          <span class="text-white">${session.start_time.substring(0, 5)} - ${session.end_time.substring(0, 5)}</span>
        </div>
        <div>
          <span class="text-gray-300">${roomLabel}:</span>
          <span class="text-white">${session.room || 'N/A'}</span>
        </div>
      </div>
    `;
    
    tooltip.classList.remove('hidden');
    
    // Position tooltip near cursor
    const x = event.clientX + 15;
    const y = event.clientY + 15;
    
    tooltip.style.left = x + 'px';
    tooltip.style.top = y + 'px';
  }

  function hideTooltip() {
    document.getElementById('course-tooltip').classList.add('hidden');
  }

  async function loadSchedule() {
    const loading = document.getElementById('schedule-loading');
    const content = document.getElementById('schedule-content');
    const empty = document.getElementById('schedule-empty');
    const error = document.getElementById('schedule-error');
    const tbody = document.getElementById('schedule-table-body');

    try {
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
      
      const response = await fetch('/api/student/schedule', {
        headers: {
          'X-CSRF-Token': csrfToken,
          'Accept': 'application/json'
        },
        credentials: 'same-origin'
      });

      loading.classList.add('hidden');

      if (!response.ok) {
        if (response.status === 404) {
          empty.classList.remove('hidden');
          return;
        }
        throw new Error('Failed to load schedule');
      }

      const scheduleDataRaw = await response.json();
      
      // Convert numeric day keys to day names
      const scheduleData = {};
      Object.keys(scheduleDataRaw).forEach(dayKey => {
        const dayName = DAY_NUMBER_TO_NAME[parseInt(dayKey)];
        if (dayName) {
          scheduleData[dayName] = scheduleDataRaw[dayKey];
        }
      });
      
      console.log('Processed schedule data:', scheduleData);
      
      // Check if schedule is empty
      if (Object.keys(scheduleData).length === 0) {
        empty.classList.remove('hidden');
        return;
      }

      // Generate table rows
      tbody.innerHTML = '';
      
      HOURS.forEach(hour => {
        const row = document.createElement('tr');
        row.className = 'border-t border-gray-200 dark:border-gray-700';
        
        // Time column
        const timeCell = document.createElement('td');
        timeCell.className = 'px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-400 border-r border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700';
        timeCell.textContent = formatTime(hour);
        row.appendChild(timeCell);
        
        // Day columns
        DAYS.forEach(day => {
          const dayCell = document.createElement('td');
          dayCell.className = 'px-2 py-2 border-r border-gray-200 dark:border-gray-600 align-top relative';
          dayCell.style.minHeight = '60px';
          dayCell.style.height = '60px';
          
          // Find sessions that START in this hour for this day
          const daySessions = scheduleData[day] || [];
          
          daySessions.forEach(session => {
            const startHour = parseTime(session.start_time);
            const endHour = parseTime(session.end_time);
            const startHourFloor = Math.floor(startHour);
            
            // Only render the session block if this is the hour when it starts
            if (startHourFloor === hour) {
              const duration = endHour - startHour;
              
              const sessionBlock = document.createElement('div');
              sessionBlock.className = 'bg-blue-100 dark:bg-blue-900 border-l-4 border-blue-600 dark:border-blue-400 rounded p-2 cursor-pointer hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors text-xs mb-1';
              
              // Calculate height based on duration (60px per hour)
              const heightPx = duration * 60;
              sessionBlock.style.height = `${heightPx}px`;
              sessionBlock.style.minHeight = '50px';
              
              sessionBlock.innerHTML = `
                <div class="font-semibold text-blue-800 dark:text-blue-200">${session.course.code}</div>
                <div class="text-blue-700 dark:text-blue-300 text-xs">${session.room || ''}</div>
              `;
              
              // Add hover event for tooltip
              sessionBlock.addEventListener('mouseenter', (e) => showTooltip(e, session));
              sessionBlock.addEventListener('mouseleave', hideTooltip);
              sessionBlock.addEventListener('mousemove', (e) => {
                const tooltip = document.getElementById('course-tooltip');
                if (!tooltip.classList.contains('hidden')) {
                  tooltip.style.left = (e.clientX + 15) + 'px';
                  tooltip.style.top = (e.clientY + 15) + 'px';
                }
              });
              
              dayCell.appendChild(sessionBlock);
            }
          });
          
          row.appendChild(dayCell);
        });
        
        tbody.appendChild(row);
      });

      content.classList.remove('hidden');

    } catch (err) {
      console.error('Error loading schedule:', err);
      loading.classList.add('hidden');
      error.textContent = 'Failed to load schedule. Please refresh the page.';
      error.classList.remove('hidden');
    }
  }

  // Load schedule on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadSchedule);
  } else {
    loadSchedule();
  }

  // Also load on Turbo navigation
  document.addEventListener('turbo:load', loadSchedule);
</script>
