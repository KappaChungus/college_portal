<div class="max-w-7xl mx-auto">
  <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-6">Teacher Surveys</h1>

  <!-- Teachers to Rate Section -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">Rate Your Teachers</h2>
    
    <!-- Loading state -->
    <div id="teachers-loading" class="flex items-center justify-center py-8">
      <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="ml-3 text-gray-600 dark:text-gray-300">Loading teachers...</span>
    </div>

    <!-- Teachers list -->
    <div id="teachers-container" class="hidden space-y-3"></div>

    <!-- Empty state -->
    <div id="teachers-empty" class="hidden text-center py-8">
      <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
      </svg>
      <p class="mt-2 text-gray-600 dark:text-gray-300">All teachers have been rated or no current courses available</p>
    </div>

    <!-- Error state -->
    <div id="teachers-error" class="hidden text-center py-8 text-red-600 dark:text-red-400"></div>
  </div>

  <!-- Survey Form Modal -->
  <div id="survey-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-lg bg-white dark:bg-gray-800">
      <div class="mb-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-semibold text-gray-900 dark:text-gray-100">Rate Teacher</h3>
          <button onclick="closeSurveyModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div id="survey-teacher-info" class="text-gray-600 dark:text-gray-300 mb-4"></div>
      </div>

      <form id="survey-form" class="space-y-4">
        <input type="hidden" id="survey-student-course-id" name="student_course_id">

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Quality of Classes Conducted (1-5) <span class="text-red-500">*</span>
          </label>
          <div class="flex gap-2">
            <input type="range" id="quality-of-classes" name="quality_of_classes_conducted" min="1" max="5" value="3" class="flex-1" required>
            <span id="quality-value" class="text-lg font-semibold text-blue-600 dark:text-blue-400 w-8">3</span>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Ease of Communication (1-5) <span class="text-red-500">*</span>
          </label>
          <div class="flex gap-2">
            <input type="range" id="ease-of-communication" name="ease_of_communication" min="1" max="5" value="3" class="flex-1" required>
            <span id="communication-value" class="text-lg font-semibold text-blue-600 dark:text-blue-400 w-8">3</span>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Fair and Clear Conditions (1-5) <span class="text-red-500">*</span>
          </label>
          <div class="flex gap-2">
            <input type="range" id="fair-conditions" name="fair_and_clear_conditions" min="1" max="5" value="3" class="flex-1" required>
            <span id="conditions-value" class="text-lg font-semibold text-blue-600 dark:text-blue-400 w-8">3</span>
          </div>
        </div>

        <div>
          <label for="detailed-opinion" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Detailed Opinion (Optional)
          </label>
          <textarea 
            id="detailed-opinion" 
            name="detailed_opinion" 
            rows="4"
            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors resize-none"
            placeholder="Share your thoughts about the teacher..."
          ></textarea>
        </div>

        <div id="survey-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"></div>

        <div class="flex gap-4 pt-4">
          <button 
            type="submit" 
            id="survey-submit-button"
            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Submit Survey
          </button>
          <button 
            type="button" 
            onclick="closeSurveyModal()"
            class="flex-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium py-2 px-4 rounded-lg transition-colors"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Previous Surveys Section -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
    <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">Your Submitted Surveys</h2>
    
    <!-- Loading state -->
    <div id="surveys-loading" class="flex items-center justify-center py-8">
      <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span class="ml-3 text-gray-600 dark:text-gray-300">Loading surveys...</span>
    </div>

    <!-- Surveys list -->
    <div id="surveys-container" class="hidden space-y-4"></div>

    <!-- Empty state -->
    <div id="surveys-empty" class="hidden text-center py-8">
      <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
      </svg>
      <p class="mt-2 text-gray-600 dark:text-gray-300">No surveys submitted yet</p>
    </div>

    <!-- Error state -->
    <div id="surveys-error" class="hidden text-center py-8 text-red-600 dark:text-red-400"></div>
  </div>
</div>

<script>
// State
let currentTeacher = null;
let currentStudentCourseId = null;

// Range input handlers
document.getElementById('quality-of-classes')?.addEventListener('input', (e) => {
  document.getElementById('quality-value').textContent = e.target.value;
});

document.getElementById('ease-of-communication')?.addEventListener('input', (e) => {
  document.getElementById('communication-value').textContent = e.target.value;
});

document.getElementById('fair-conditions')?.addEventListener('input', (e) => {
  document.getElementById('conditions-value').textContent = e.target.value;
});

// Load teachers to rate
async function loadTeachers() {
  const loading = document.getElementById('teachers-loading');
  const container = document.getElementById('teachers-container');
  const empty = document.getElementById('teachers-empty');
  const error = document.getElementById('teachers-error');

  try {
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    
    const response = await fetch('/api/student/current_teachers', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'X-CSRF-Token': csrfToken
      },
      credentials: 'same-origin'
    });

    if (!response.ok) throw new Error('Failed to load teachers');

    const teachers = await response.json();
    
    loading.classList.add('hidden');

    if (teachers.length === 0 || teachers.every(t => t.rated)) {
      empty.classList.remove('hidden');
      return;
    }

    container.classList.remove('hidden');
    container.innerHTML = '';

    teachers.forEach(item => {
      const teacherCard = document.createElement('div');
      teacherCard.className = 'flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 dark:bg-gray-700 rounded-lg hover:border-blue-300 dark:hover:border-blue-500 transition-colors';
      
      if (item.rated) {
        // Show disabled button for rated teachers
        teacherCard.innerHTML = `
          <div>
            <h3 class="font-semibold text-gray-900 dark:text-gray-100">${item.teacher.name}</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300">${item.subject || 'N/A'}</p>
            <p class="text-xs text-gray-500 dark:text-gray-400">${item.teacher.email}</p>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-sm text-green-600 dark:text-green-400 font-medium">âœ“ Rated</span>
            <button 
              disabled
              class="bg-gray-300 dark:bg-gray-600 text-gray-500 dark:text-gray-400 font-medium py-2 px-4 rounded-lg cursor-not-allowed"
            >
              Already Rated
            </button>
          </div>
        `;
      } else {
        // Show active button for unrated teachers
        teacherCard.innerHTML = `
          <div>
            <h3 class="font-semibold text-gray-900 dark:text-gray-100">${item.teacher.name}</h3>
            <p class="text-sm text-gray-600 dark:text-gray-300">${item.subject || 'N/A'}</p>
            <p class="text-xs text-gray-500 dark:text-gray-400">${item.teacher.email}</p>
          </div>
          <button 
            onclick="openSurveyModal(${item.teacher.id}, '${item.teacher.name}', '${item.subject || 'N/A'}')"
            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"
          >
            Rate Teacher
          </button>
        `;
      }
      
      container.appendChild(teacherCard);
    });

    if (container.children.length === 0) {
      container.classList.add('hidden');
      empty.classList.remove('hidden');
    } else {
      container.classList.remove('hidden');
      empty.classList.add('hidden');
    }

  } catch (err) {
    console.error('Error loading teachers:', err);
    loading.classList.add('hidden');
    error.textContent = 'Failed to load teachers. Please refresh the page.';
    error.classList.remove('hidden');
  }
}

// Load previous surveys
async function loadSurveys() {
  const loading = document.getElementById('surveys-loading');
  const container = document.getElementById('surveys-container');
  const empty = document.getElementById('surveys-empty');
  const error = document.getElementById('surveys-error');

  try {
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    
    const response = await fetch('/api/student/surveys', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'X-CSRF-Token': csrfToken
      },
      credentials: 'same-origin'
    });

    if (!response.ok) throw new Error('Failed to load surveys');

    const surveys = await response.json();
    
    loading.classList.add('hidden');

    if (surveys.length === 0) {
      container.classList.add('hidden');
      empty.classList.remove('hidden');
      return;
    }

    // Hide empty state and show container
    empty.classList.add('hidden');
    container.classList.remove('hidden');
    container.innerHTML = '';

    surveys.forEach(survey => {
      const date = new Date(survey.created_at);
      const formattedDate = date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      const surveyCard = document.createElement('div');
      surveyCard.className = 'p-4 border border-gray-200 dark:border-gray-700 dark:bg-gray-700 rounded-lg';
      
      surveyCard.innerHTML = `
        <div class="flex justify-between items-start mb-3">
          <div>
            <h3 class="font-semibold text-gray-900 dark:text-gray-100">${survey.teacher?.name || 'Unknown Teacher'}</h3>
            <p class="text-xs text-gray-500 dark:text-gray-400">${formattedDate}</p>
          </div>
        </div>
        ${survey.detail ? `
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-300">Quality of Classes:</span>
              <span class="font-semibold text-gray-900 dark:text-gray-100">${survey.detail.quality_of_classes_conducted}/5</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-300">Ease of Communication:</span>
              <span class="font-semibold text-gray-900 dark:text-gray-100">${survey.detail.ease_of_communication}/5</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600 dark:text-gray-300">Fair and Clear Conditions:</span>
              <span class="font-semibold text-gray-900 dark:text-gray-100">${survey.detail.fair_and_clear_conditions}/5</span>
            </div>
            ${survey.detail.detailed_opinion ? `
              <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                <p class="text-gray-600 dark:text-gray-300 italic">"${survey.detail.detailed_opinion}"</p>
              </div>
            ` : ''}
          </div>
        ` : '<p class="text-gray-500 dark:text-gray-400">No details available</p>'}
      `;
      
      container.appendChild(surveyCard);
    });

  } catch (err) {
    console.error('Error loading surveys:', err);
    loading.classList.add('hidden');
    error.textContent = 'Failed to load surveys. Please refresh the page.';
    error.classList.remove('hidden');
  }
}

// Open survey modal
async function openSurveyModal(teacherId, teacherName, subject) {
  try {
    // Get student course ID for this teacher
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    const response = await fetch('/api/student/current_teachers', {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
        'X-CSRF-Token': csrfToken
      },
      credentials: 'same-origin'
    });

    if (!response.ok) throw new Error('Failed to load teacher info');

    const teachers = await response.json();
    const teacherData = teachers.find(t => t.teacher.id === teacherId);
    
    if (!teacherData) {
      alert('Teacher data not found');
      return;
    }

    // Note: We need to get student_course_id. The API doesn't return it directly,
    // so we'll need to modify this. For now, we'll use teacher_id
    currentTeacher = { id: teacherId, name: teacherName, subject };
    currentStudentCourseId = teacherId; // This should be student_course_id

    document.getElementById('survey-teacher-info').innerHTML = `
      <strong>${teacherName}</strong> - ${subject}
    `;
    
    document.getElementById('survey-modal').classList.remove('hidden');
  } catch (err) {
    console.error('Error opening modal:', err);
    alert('Failed to open survey form');
  }
}

// Close survey modal
function closeSurveyModal() {
  document.getElementById('survey-modal').classList.add('hidden');
  document.getElementById('survey-form').reset();
  document.getElementById('survey-error').classList.add('hidden');
  document.getElementById('quality-value').textContent = '3';
  document.getElementById('communication-value').textContent = '3';
  document.getElementById('conditions-value').textContent = '3';
  currentTeacher = null;
  currentStudentCourseId = null;
}

// Submit survey
document.getElementById('survey-form')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const submitButton = document.getElementById('survey-submit-button');
  const errorDiv = document.getElementById('survey-error');
  
  errorDiv.classList.add('hidden');
  submitButton.disabled = true;
  submitButton.textContent = 'Submitting...';
  
  const formData = {
    survey: {
      student_course_id: currentStudentCourseId,
      quality_of_classes_conducted: parseInt(document.getElementById('quality-of-classes').value),
      ease_of_communication: parseInt(document.getElementById('ease-of-communication').value),
      fair_and_clear_conditions: parseInt(document.getElementById('fair-conditions').value),
      detailed_opinion: document.getElementById('detailed-opinion').value.trim()
    }
  };
  
  try {
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    
    const response = await fetch('/api/student/surveys', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken,
        'Accept': 'application/json'
      },
      credentials: 'same-origin',
      body: JSON.stringify(formData)
    });
    
    const data = await response.json();
    
    if (response.ok) {
      closeSurveyModal();
      // Reload both lists
      loadTeachers();
      loadSurveys();
    } else {
      const errors = data.errors || data.error || ['Failed to submit survey'];
      errorDiv.textContent = Array.isArray(errors) ? errors.join(', ') : errors;
      errorDiv.classList.remove('hidden');
      submitButton.disabled = false;
      submitButton.textContent = 'Submit Survey';
    }
  } catch (error) {
    console.error('Error submitting survey:', error);
    errorDiv.textContent = 'Network error. Please try again.';
    errorDiv.classList.remove('hidden');
    submitButton.disabled = false;
    submitButton.textContent = 'Submit Survey';
  }
});

// Load data on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    loadTeachers();
    loadSurveys();
  });
} else {
  loadTeachers();
  loadSurveys();
}
</script>
